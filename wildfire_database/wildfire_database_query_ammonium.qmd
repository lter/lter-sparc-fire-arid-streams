---
format: gfm
engine: knitr
---

# ammonium

## view: combined ammonium

Create a view of standardized (forms, units) ammonium that reflects data from
from both the USGS and non-USGS data sources.

Convert NEON and SBC data (micromoles) to `mg NO3-N / L`.

```{sql}
#| eval: FALSE

DROP VIEW IF EXISTS firearea.ammonium ;

CREATE TEMPORARY TABLE ammonium AS 
SELECT
  usgs_site,
  "ActivityStartDate" AS date,
  'ammonium' as analyte,
  AVG (value_std) AS value_std,
  'mg/L as N' AS units_std
FROM firearea.usgs_water_chem_std
WHERE "USGSPCode" IN ('00608')
GROUP BY
  usgs_site,
  date
UNION
SELECT
  usgs_site,
  date,
  analyte,
  mean AS value_std,
  unit AS units_std
FROM firearea.non_usgs_water_chem
WHERE analyte ~~* '%nh4%'
;

```


## view: ammonium_ranges (unused)

Generate a view of summary statistics surrounding ammonium data availability
(number of samples pre, post fire; time (days) since previous fire; etc.).

The `chem_ranges` CTE uses the template detailed in `chemistry with ranges`.

The `num_pre_fire` and `num_post_fire` reflect the number of ammonium
observations in the period between the fire of interest and the previous and
next fires, respectively; not to be confused with the number of observations at
any point prior to and after the fire of interest, respectively.

The number of ammonium observations reflects observations for which there is
also a discharge measurement.

This query is likely not to be employed as the project has decided to use
aggregated fires in the fire season (this query addressed only unaggregated
data) but I think there are some errors here so it should be evaluated before a
possible future use.

```{sql}
#| eval: FALSE

DROP VIEW IF EXISTS firearea.ammonium_ranges ;

CREATE VIEW firearea.ammonium_ranges AS 
WITH chem_ranges AS (
  SELECT
    ammonium.usgs_site,
    ammonium.date,
    ammonium.value_std,
    ranges.event AS pre,
    ranges_post.post
  FROM firearea.ammonium
  JOIN firearea.discharge ON (
    discharge."Date" = ammonium.date
    AND discharge.usgs_site = ammonium.usgs_site
  )
  LEFT JOIN firearea.ranges ON (
    ammonium.usgs_site = ranges.usgs_site
    -- AND daterange(ammonium.date, ammonium.date, '[]') && ranges.pre
    AND ranges.pre @> ammonium.date
  )
  LEFT JOIN (
    SELECT
      ammonium.usgs_site,
      ammonium.date,
      ranges.event AS post
    FROM firearea.ammonium 
    LEFT JOIN firearea.ranges ON (
      ammonium.usgs_site = ranges.usgs_site
      -- AND daterange(ammonium.date, ammonium.date, '[]') && ranges.post
      AND ranges.post @> ammonium.date
    )
  ) AS ranges_post ON (
    ranges_post.usgs_site = ammonium.usgs_site
    AND ranges_post.date = ammonium.date
  )
  ORDER BY
    ammonium.usgs_site,
    ammonium.date
)
SELECT
  pre_fire.usgs_site,
  pre_fire.pre AS event,
  adjacent_fire.date,
  adjacent_fire.days_since_prior_fire,
  pre_fire.num_pre_fire,
  post_fire.num_post_fire
FROM (
  SELECT
    chem_ranges.usgs_site,
    chem_ranges.pre,
    count(chem_ranges.pre) AS num_pre_fire
  FROM chem_ranges
  GROUP BY
    chem_ranges.usgs_site,
    chem_ranges.pre
) AS pre_fire
JOIN (
  SELECT
    chem_ranges.usgs_site,
    chem_ranges.post,
    count(chem_ranges.post) AS num_post_fire
  FROM chem_ranges
  GROUP BY
    chem_ranges.usgs_site,
    chem_ranges.post
) AS post_fire ON (
    post_fire.usgs_site = pre_fire.usgs_site
    AND post_fire.post  = pre_fire.pre
)
LEFT JOIN (
  SELECT
    usgs_site,
    date,
    event,
    UPPER(ranges.pre) - LOWER(ranges.pre) AS days_since_prior_fire
  FROM firearea.ranges
) AS adjacent_fire ON (
    adjacent_fire.usgs_site = pre_fire.usgs_site
    AND adjacent_fire.event = pre_fire.pre
)
;

```


## view: analyte_counts (summer)

```{sql}
#| eval: FALSE

SELECT firearea.create_analyte_counts_view('ammonium');

```


## m.view: largest fire

```{sql}
#| eval: FALSE

SELECT firearea.create_largest_analyte_valid_fire_per_site_mv('ammonium');
-- REFRESH MATERIALIZED VIEW firearea.largest_ammonium_valid_fire_per_site ;

```


## export: summary all sites

See full metadata [here]. Basically, though, catchment and summary statistics for
all sites associated with this analyte.

```{sql}
#| eval: FALSE

SELECT firearea.export_analyte_summary_all_sites('ammonium');

```


## export: summary largest fire sites

See full metadata [here]. Basically, though, catchment and summary statistics
for all sites associated with this analyte for the largest fire.

```{sql}
#| eval: FALSE

SELECT firearea.export_analyte_largest_fire_sites('ammonium'::TEXT);

```


## export: q+c all

All analyte + discharge observations. Used for testing but not analyses.

```{sql}
#| eval: FALSE

\COPY (
SELECT
  ammonium.*,
  discharge."Flow",
  discharge.quartile
FROM firearea.ammonium
JOIN firearea.discharge ON (
  discharge."Date" = ammonium.date
  AND discharge.usgs_site = ammonium.usgs_site
)
ORDER BY
  ammonium.usgs_site,
  ammonium.date
) TO '/tmp/ammonium_q_chem.csv' WITH CSV HEADER
;

```


## export: q+c pre-post-quartiles

synopsis:

This function generates a query (`{analyte}_q_upper_quartiles`) that extracts
paired analyte and discharge observations from USGS and non-USGS monitoring
sites focusing on the periods before and after fire.

For each site/fire window, requires:
  - analyte–discharge observations in both the 3-year pre- and post-fire
  windows
  - analyte–discharge observations must include flow quartiles 2, 3, and 4 in
  both windows

Full metadata [here].

The query result is saved as: `{analyte}_discharge_data_filtered_quartiles_234.csv`

```{sql}
#| eval: FALSE

SELECT firearea.export_analyte_q_pre_post_quartiles('ammonium'::TEXT);

```


## export: q+c pre-post-quartiles largest fire

purpose:

This query extracts analyte and discharge observations from USGS watershed sites
surrounding wildfires. It isolates data for only the largest valid fire per
watershed, where validity is defined by the presence of adequate water quality
monitoring data before and after the fire.

filtering:

- Limit analysis to only the most impactful fire per watershed, based on fire
  area (`cum_fire_area`).
- ensure fire events are sufficiently monitored, with:
  - At least 3 years of data before and after the fire.
  - Presence of streamflow across flow quartiles 2, 3, and 4 in both windows.

The query result is saved as: `{analyte}_discharge_quartiles_234_max_fire.csv`

```{sql}
#| eval: FALSE

SELECT firearea.export_analyte_q_pre_post_quartiles_largest_fire('ammonium'::TEXT);

```


## export: q+c pre-quartiles largest fire

purpose:

This query retrieves ammonium and discharge records for USGS watershed sites
(`usgs_site`) surrounding wildfires. It ensures strong sampling coverage before
the fire, requiring observations in flow quartiles 2, 3, and 4, while placing no
constraint on post-fire sampling coverage.

The query result is saved as: `{analyte}_discharge_before_quartiles_234_max_fire.csv`

```{sql}
#| eval: FALSE

SELECT firearea.export_analyte_q_pre_quartiles_largest_fire('ammonium'::TEXT);

```
